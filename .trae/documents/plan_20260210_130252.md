I have analyzed your request for an automatic stock management system with immediate reservation and expiration logic. Based on your requirements and the current system state, here is the implementation plan.

### **Core Logic & Clarifications**
*   **Immediate Reservation (SO)**: Stock will be deducted immediately upon **creation** (Draft status) of a Sales Order. This acts as a "Hard Reservation".
*   **Purchase Order (PO) Behavior**:
    *   *Note*: Your instruction mentioned POs should also "reduce" stock. In standard ERP flows, POs (buying goods) **increase** stock.
    *   *Proposal*: I will implement POs to **increase** stock (or `incoming_stock`). If you strictly meant "reduce" (e.g., for Purchase Returns), please clarify. I will assume **Increase** for now to maintain logical consistency.
*   **Auto-Reversal**: Stock will be returned/reverted if an order is `cancelled` or becomes `expired` (> 7 days).

### **Implementation Steps**

#### 1. Database Schema & Triggers (Supabase/PostgreSQL)
*   **Modify Triggers**:
    *   Replace the previous "Status-Based" triggers with "Event-Based" triggers (Insert/Update/Delete).
    *   **Trigger `trg_reserve_stock_so`**: Fires on `INSERT` to `order_items`. Deducts `products.stock_quantity`.
    *   **Trigger `trg_revert_stock_so`**: Fires when `orders.status` changes to `cancelled` or `expired`. Adds stock back.
    *   **Trigger `trg_incoming_stock_po`**: Fires on `INSERT` to `purchase_order_items`. (Adds to stock).
*   **Validation**: Add `CHECK (stock_quantity >= 0)` constraint or trigger-based exception to prevent negative stock.
*   **Timestamp**: Ensure `inventory_movements` captures the exact time of reservation.

#### 2. Expiration Mechanism
*   **Status Update**: Add `expired` to the allowed values for `orders.status` and `purchase_orders.status`.
*   **Stored Procedure**: Create `check_and_expire_orders()` function in PostgreSQL that:
    *   Finds orders created > 7 days ago with status `draft`/`pending`.
    *   Updates status to `expired`.
    *   (The trigger above will automatically handle the stock reversal).
*   **Execution**: Since we cannot easily configure `pg_cron` in this environment, I will provide a SQL function that can be called via an API endpoint or scheduled task.

#### 3. Testing (Vitest)
*   Create `stock_reservation.test.ts` to verify:
    *   Stock deduction immediately upon item addition.
    *   Stock restoration upon cancellation.
    *   Stock restoration upon expiration (simulating time passage).
    *   Prevention of negative stock (Error handling).

#### 4. Documentation
*   Update `DOCS_STOCK_UPDATES.md` with the new "Reservation Model" logic and API usage for expiration checks.

### **Confirmations Required**
1.  **PO Logic**: Do you confirm that Purchase Orders should **INCREASE** stock (standard) or strictly **REDUCE** stock (as per prompt)? *I will proceed with INCREASE unless corrected.*
2.  **Immediate Effect**: Confirm that even `Draft` orders should reserve stock? (This effectively locks inventory while typing).

I will begin implementation immediately upon your approval.